<!doctype html>
<html lang="en">

<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width,initial-scale=1" />
	<title>HackTheVote.exe â€” Live</title>

	<!-- Fonts -->
	<link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&family=Press+Start+2P&display=swap" rel="stylesheet">

	<style>
		:root {
			--bg: #000;
			--cyan: #00d4ff;
			--green: #39ff14;
			--pink: #ff4dff;
			--panel: rgba(0, 0, 0, 0.78);
			--text: #eaffff;
		}

		* {
			box-sizing: border-box
		}

		html,
		body {
			height: 100%;
			margin: 0;
			background: var(--bg);
			color: var(--text);
			font-family: "Roboto Mono", "Press Start 2P", monospace
		}

		canvas#matrix {
			position: fixed;
			inset: 0;
			width: 100%;
			height: 100%;
			z-index: -2
		}

		/* Window/title */
		.container {
			width: 95%;
			max-width: 1200px;
			margin: 18px auto;
			border-radius: 8px;
			overflow: hidden;
			box-shadow: 0 18px 60px rgba(0, 0, 0, 0.75);
			z-index: 10
		}

		.titlebar {
			display: flex;
			align-items: center;
			justify-content: space-between;
			padding: 12px 14px;
			background: linear-gradient(180deg, #071014, #051014);
			border-bottom: 2px solid rgba(0, 255, 200, 0.06)
		}

		.title-left {
			display: flex;
			align-items: center;
			gap: 12px
		}

		.win-dots {
			display: flex;
			gap: 8px
		}

		.win-dot {
			width: 12px;
			height: 12px;
			border-radius: 3px
		}

		.dot-red {
			background: #ff6b6b
		}

		.dot-yellow {
			background: #ffd166
		}

		.dot-green {
			background: #6bff8a
		}

		.title-text {
			font-size: 13px;
			color: #cfeff0
		}

		.logo-top {
			height: 72px
		}

		/* layout */
		.content {
			display: grid;
			grid-template-columns: 1fr 380px;
			gap: 18px;
			padding: 18px;
			background: linear-gradient(180deg, rgba(0, 0, 0, 0.18), rgba(0, 0, 0, 0.28))
		}

		@media(max-width:980px) {
			.content {
				grid-template-columns: 1fr;
				padding: 12px
			}
		}

		.panel {
			background: var(--panel);
			border-radius: 10px;
			padding: 14px;
			border: 2px solid rgba(0, 255, 200, 0.06)
		}

		h2 {
			margin: 0 0 10px 0;
			font-size: 16px
		}

		p {
			margin: 0 0 8px 0;
			color: #dff;
			font-size: 13px;
			line-height: 1.4
		}

		/* voting */
		.vote-note {
			font-size: 12px;
			color: var(--cyan);
			margin-bottom: 8px
		}

		.vote-buttons {
			display: flex;
			flex-wrap: wrap;
			gap: 12px
		}

		.vote-btn {
			flex: 1 1 calc(50% - 12px);
			min-width: 140px;
			padding: 12px;
			border-radius: 8px;
			border: 2px solid rgba(0, 255, 200, 0.08);
			background: rgba(255, 255, 255, 0.02);
			color: var(--text);
			cursor: pointer;
			position: relative;
			text-align: center;
			font-size: 13px;
			transition: transform .12s ease, background .12s ease;
		}

		.vote-btn:hover {
			transform: scale(1.03);
			background: linear-gradient(90deg, var(--cyan), var(--green));
			color: #001
		}

		.vote-count {
			position: absolute;
			top: 6px;
			right: 10px;
			font-size: 11px;
			color: var(--pink)
		}

		.timer {
			margin-top: 12px;
			font-weight: 700;
			text-align: center;
			font-size: 14px
		}

		.phase {
			font-size: 12px;
			color: var(--cyan);
			text-align: center;
			margin-top: 6px
		}

		/* reactor */
		.reactor-bar {
			width: 100%;
			background: rgba(0, 0, 0, 0.55);
			height: 34px;
			margin-top: 12px;
			border-radius: 10px;
			border: 2px solid rgba(0, 255, 200, 0.06);
			overflow: hidden
		}

		.reactor-fill {
			height: 100%;
			width: 0;
			background: linear-gradient(90deg, var(--cyan), var(--green));
			transition: width .45s ease-in-out
		}

		/* vault */
		.vault-list {
			max-height: 260px;
			overflow: auto;
			margin-top: 12px;
			padding: 10px;
			background: rgba(0, 0, 0, 0.5);
			border-radius: 8px;
			border: 1px solid rgba(0, 255, 200, 0.04);
			font-size: 13px;
			color: #dff
		}

		.vault-item {
			padding: 8px;
			border-bottom: 1px dashed rgba(255, 255, 255, 0.03)
		}

		/* chat */
		.chat-messages {
			height: 300px;
			overflow: auto;
			padding: 10px;
			background: rgba(0, 0, 0, 0.5);
			border-radius: 8px;
			border: 1px solid rgba(0, 255, 200, 0.04);
			font-size: 13px;
			color: #eaffff
		}

		.chat-line {
			padding: 6px 0;
			border-bottom: 1px dotted rgba(255, 255, 255, 0.02)
		}

		.chat-controls {
			display: flex;
			gap: 8px;
			margin-top: 8px
		}

		.chat-input {
			flex: 1;
			padding: 10px;
			border-radius: 8px;
			border: 2px solid rgba(0, 255, 200, 0.06);
			background: rgba(255, 255, 255, 0.02);
			color: #fff
		}

		.chat-send {
			padding: 10px 12px;
			border-radius: 8px;
			border: 2px solid rgba(0, 255, 200, 0.06);
			background: transparent;
			color: #fff;
			cursor: pointer
		}

		.chat-send:hover {
			background: rgba(0, 255, 200, 0.08);
			color: #001
		}

		/* buy */
		.buy-btn {
			display: inline-block;
			padding: 10px 12px;
			border-radius: 8px;
			border: 2px solid rgba(0, 255, 200, 0.08);
			color: #fff;
			text-decoration: none;
			margin-bottom: 6px;
			font-size: 13px
		}

		.buy-btn:hover {
			background: rgba(0, 255, 200, 0.08);
			color: #001
		}

		/* roadmap */
		.roadmap ul {
			padding-left: 18px;
			margin-top: 8px
		}

		footer {
			text-align: center;
			padding: 14px;
			color: #9fd;
			margin-top: 18px
		}

		#winnerOverlay {
			position: fixed;
			inset: 0;
			background: rgba(0, 0, 0, 0.92);
			display: none;
			align-items: center;
			justify-content: center;
			z-index: 9999
		}

		#winnerOverlay .box {
			background: linear-gradient(180deg, rgba(0, 0, 0, 0.9), rgba(0, 0, 0, 0.85));
			padding: 18px;
			border-radius: 10px;
			border: 3px solid rgba(0, 255, 200, 0.06);
			max-width: 760px;
			text-align: center;
			color: #fff
		}

		@media(max-width:980px) {
			.vote-btn {
				flex: 1 1 100%
			}

			.chat-messages {
				height: 220px
			}

			.content {
				grid-template-columns: 1fr
			}
		}
	</style>
</head>

<body>

	<canvas id="matrix"></canvas>

	<div class="container" role="application" aria-label="HackTheVote terminal site">
		<div class="titlebar">
			<div class="title-left">
				<div class="win-dots" aria-hidden="true">
					<span class="win-dot dot-red"></span>
					<span class="win-dot dot-yellow"></span>
					<span class="win-dot dot-green"></span>
				</div>
				<img src="hackthevote-logo.png" alt="HackTheVote logo" class="logo-top" id="logoEl">
				<div class="title-text">HackTheVote.exe â€” Community Terminal</div>
			</div>
			<div style="font-size:12px;color:#cfeff0">Windows Terminal â€¢ Live</div>
		</div>

		<div class="content">
			<!-- LEFT -->
			<div>
				<div class="panel">
					<h2>HackTheVote.exe â€” Community Decision Meme Coin</h2>
					<p>Community-driven token. Every <strong>3 hours</strong> the community votes on how creator rewards are spent: Buybacks & Burns, Giveaways, Boosts, or Donate to Good Causes. Fair launch â€” developer purchased only <strong>1%</strong> of supply. 100% of creator fees are controlled by community vote.</p>
				</div>

				<div class="panel" style="margin-top:12px;">
					<h2>Vote Now</h2>
					<div class="vote-note">Max votes per IP per 3-hour window: <strong id="maxLabel">4</strong></div>

					<div class="vote-buttons" id="voteButtons" aria-live="polite"></div>

					<div class="timer" id="voteTimer">Voting ends in: --:--:--</div>
					<div class="phase" id="phaseText">Phase: loading...</div>

					<div class="reactor-bar">
						<div class="reactor-fill" id="reactorFill"></div>
					</div>

					<div class="vault-list" id="vaultList" aria-live="polite">
						<div style="color:var(--pink);font-size:13px;padding-bottom:6px">Vault of Decisions (past winners)</div>
						<div id="vaultItems"><em style="color:#bfe">No past decisions yet.</em></div>
					</div>
				</div>
			</div>

			<!-- RIGHT -->
			<aside>
				<div class="panel" style="text-align:center">
					<a class="buy-btn" href="https://pump.fun/profile/cryptocentric?tab=coins" target="_blank" rel="noopener">Buy on Pump.Fun</a>
					<div style="font-size:12px;margin-top:8px;color:var(--cyan)">Pump.Fun profile</div>
				</div>

				<div class="panel" style="margin-top:12px">
					<div style="font-weight:700;text-align:center;color:#fff;margin-bottom:8px">Terminal Chat</div>
					<div class="chat-messages" id="chatMessages" aria-live="polite"></div>

					<div class="chat-controls">
						<input id="chatInput" class="chat-input" placeholder="Type a message..." maxlength="220" />
						<button id="chatSendBtn" class="chat-send">Send</button>
					</div>
					<div style="font-size:12px;color:var(--cyan);margin-top:8px;text-align:center">Auto-generated hacker nicknames (persistent)</div>
				</div>

				<div class="panel" style="margin-top:12px">
					<h2 style="margin:0 0 8px 0">Roadmap & Rules</h2>
					<p style="font-size:13px;color:#e8fbff">Community first. Fair launch: developer purchased only <strong>1%</strong> of supply. 100% of creator fees will be used for community-selected actions (buybacks, giveaways, boosts, charity). Winners are archived in the Vault for transparency.</p>
					<ul class="roadmap">
						<li>Fair Launch & Community Onboarding</li>
						<li>Live Voting Drives Decisions</li>
						<li>Transparent Vault of Winners</li>
					</ul>
				</div>
			</aside>
		</div>
	</div>

	<footer>Â© 2025 HackTheVote.exe â€” Live</footer>

	<!-- Winner overlay -->
	<div id="winnerOverlay">
		<div class="box">
			<h2 id="winnerTitle">ðŸ’¡ The People Have Spoken â€” Decision Confirmed</h2>
			<div id="winnerSummary" style="color:var(--cyan);margin-bottom:8px"></div>
			<div id="winnerTimer" style="font-weight:700;margin-bottom:12px"></div>
			<button id="closeWinnerBtn" style="padding:10px 12px;border-radius:8px;border:2px solid rgba(0,255,200,0.08);background:transparent;color:#fff;cursor:pointer">Close</button>
		</div>
	</div>

	<!-- Firebase compat libs -->
	<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
	<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

	<script>
		/* ============================
   PRODUCTION CONFIG (from you)
   ============================ */
		const firebaseConfig = {
			apiKey: "AIzaSyCWF3LkzFPSF0TAbkN-TUbHslCyHxf2wLE",
			authDomain: "hackthevote2.firebaseapp.com",
			projectId: "hackthevote2",
			storageBucket: "hackthevote2.firebasestorage.app",
			messagingSenderId: "951618635774",
			appId: "1:951618635774:web:b5aee200dc906c12aee2af",
			databaseURL: "https://hackthevote2-default-rtdb.firebaseio.com/"
		};
		firebase.initializeApp(firebaseConfig);
		const db = firebase.database();

		/* ============================
		   SETTINGS
		   ============================ */
		const VOTE_OPTIONS = ["Buybacks & Burns", "Giveaways", "Boosts", "Donate to Good Causes"];
		const MAX_VOTES_PER_IP = 4;
		const VOTE_WINDOW_MS = 3 * 60 * 60 * 1000; // 3 hours
		const REVEAL_WINDOW_MS = 1 * 60 * 60 * 1000; // 1 hour reveal
		const CYCLE_MS = VOTE_WINDOW_MS + REVEAL_WINDOW_MS;
		const IP_CHECK_URL = "https://api.ipify.org?format=json";

		/* ============================
		   Helpers
		   ============================ */
		function safeKey(s) { return encodeURIComponent(s); }

		function fmtTime(ms) {
			if (ms < 0) ms = 0;
			const hrs = Math.floor(ms / 3600000);
			const mins = Math.floor((ms % 3600000) / 60000);
			const secs = Math.floor((ms % 60000) / 1000);
			return `${String(hrs).padStart(2,"0")}:${String(mins).padStart(2,"0")}:${String(secs).padStart(2,"0")}`;
		}

		/* ============================
		   State & UI elements
		   ============================ */
		const voteButtonsEl = document.getElementById("voteButtons");
		const voteTimerEl = document.getElementById("voteTimer");
		const phaseTextEl = document.getElementById("phaseText");
		const reactorFillEl = document.getElementById("reactorFill");
		const vaultItemsEl = document.getElementById("vaultItems");
		const chatMessagesEl = document.getElementById("chatMessages");
		const chatInputEl = document.getElementById("chatInput");
		const chatSendBtn = document.getElementById("chatSendBtn");
		const winnerOverlay = document.getElementById("winnerOverlay");
		const winnerSummary = document.getElementById("winnerSummary");
		const winnerTimer = document.getElementById("winnerTimer");
		const closeWinnerBtn = document.getElementById("closeWinnerBtn");

		/* ============================
		   Nick generation
		   ============================ */
		const ADJ = ["Phantom", "Neon", "Ghost", "Silent", "Cold", "Frost", "Shadow", "Quantum", "Static", "Zero", "Null", "Cipher", "Rogue", "Vex", "Echo", "Blade"];
		const NOUN = ["Byte", "Cipher", "Kernel", "Spike", "Flux", "Proxy", "Packet", "Node", "Virus", "Matrix", "Grid", "Pulse", "Trace", "Terminal", "Vector", "Ghost"];

		function djb2(s) { let h = 5381; for (let i = 0; i < s.length; i++) h = ((h << 5) + h) + s.charCodeAt(i); return Math.abs(h); }

		function nickFromId(id) { const h = djb2(id); const adj = ADJ[h % ADJ.length]; const noun = NOUN[Math.floor(h / 100) % NOUN.length]; return `${adj}${noun}${String(h%100).padStart(2,'0')}`; }

		function getAnonId() {
			let a = localStorage.getItem('htv_anon_id');
			if (!a) { a = 'anon-' + Math.random().toString(36).slice(2, 10);
				localStorage.setItem('htv_anon_id', a); }
			return a;
		}
		const ANON_ID = getAnonId();
		let clientIP = null;
		(async function fetchIP() { try { const r = await fetch(IP_CHECK_URL); const j = await r.json();
				clientIP = j.ip.replace(/\./g, '-'); } catch (e) { clientIP = null; } })();

		function getUserId() { return clientIP ? clientIP : ANON_ID; }

		function getUserNick() { return nickFromId(getUserId()); }

		/* ============================
		   Setup initial DB structure
		   ============================ */
		async function ensureDbInit() {
			// votes node
			const votesSnap = await db.ref("votes").once("value");
			if (!votesSnap.exists()) {
				const init = {};
				VOTE_OPTIONS.forEach(o => init[safeKey(o)] = 0);
				await db.ref("votes").set(init);
			}
			// voteStart
			await db.ref("voteStart").transaction(curr => {
				if (curr === null) return Date.now();
				return; // keep
			});
		}
		ensureDbInit().catch(e => console.warn("DB init error", e));

		/* ============================
		   Render vote buttons & counts
		   ============================ */
		function createVoteButtons() {
			voteButtonsEl.innerHTML = '';
			VOTE_OPTIONS.forEach(opt => {
				const key = safeKey(opt);
				const btn = document.createElement('button');
				btn.className = 'vote-btn';
				btn.dataset.opt = opt;
				btn.innerText = opt;
				const span = document.createElement('span');
				span.className = 'vote-count';
				span.id = `count-${key}`;
				span.innerText = '0';
				btn.appendChild(span);
				btn.addEventListener('click', () => attemptVote(opt));
				voteButtonsEl.appendChild(btn);
			});
		}
		createVoteButtons();

		/* ============================
		   Live listeners: votes, voteStart, vault, chat
		   ============================ */
		db.ref("votes").on("value", snap => {
			const data = snap.val() || {};
			let total = 0;
			VOTE_OPTIONS.forEach(opt => {
				const k = safeKey(opt);
				const c = Number(data[k] || 0);
				const el = document.getElementById(`count-${k}`);
				if (el) el.innerText = c;
				total += c;
			});
			// reactor fill: e.g. total*5 capped 100
			const pct = Math.min(100, total * 5);
			if (reactorFillEl) reactorFillEl.style.width = pct + "%";
		});

		db.ref("vault").limitToLast(100).on("value", snap => {
			const val = snap.val() || {};
			const items = Object.values(val);
			items.sort((a, b) => b.timestamp - a.timestamp);
			vaultItemsEl.innerHTML = '';
			if (items.length === 0) { vaultItemsEl.innerHTML = '<em style="color:#bfe">No past decisions yet.</em>'; return; }
			items.forEach(e => {
				const d = new Date(e.timestamp);
				const div = document.createElement('div');
				div.className = 'vault-item';
				div.innerHTML = `<div style="color:var(--pink);font-size:13px">${d.toLocaleString()} â€” Winner: ${e.winner}</div>
                     <div style="font-size:12px;color:#dff">Counts: ${Object.entries(e.counts||{}).map(kv=> `
				$ { decodeURIComponent(kv[0]) }: $ { kv[1] }
				`).join(', ')}</div>`;
				vaultItemsEl.appendChild(div);
			});
		});

		db.ref("chat").limitToLast(500).on("child_added", snap => {
			const m = snap.val();
			if (!m) return;
			const el = document.createElement('div');
			el.className = 'chat-line';
			el.textContent = `[${new Date(m.ts).toLocaleTimeString()}] [${m.nick}] ${m.text}`;
			chatMessagesEl.appendChild(el);
			chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
		});

		/* ============================
		   Sync voteStart -> timers & phases
		   ============================ */
		let currentVoteStart = null;
		db.ref("voteStart").on("value", snap => {
			const val = snap.val();
			if (!val) return;
			currentVoteStart = Number(val);
			updatePhaseAndTimers();
		});

		/* ============================
		   Phase/timer logic
		   ============================ */
		let timersInterval = null;
		let lastHandledCycle = null;

		function updatePhaseAndTimers() {
			if (timersInterval) clearInterval(timersInterval);

			function tick() {
				if (!currentVoteStart) { return; }
				const now = Date.now();
				// align cycle
				let start = Number(currentVoteStart);
				if (start > now) start = now;
				const diff = now - start;
				const cyclesPassed = Math.floor(diff / CYCLE_MS);
				const cycleStart = start + cyclesPassed * CYCLE_MS;
				const voteWindowEnd = cycleStart + VOTE_WINDOW_MS;
				const revealEnd = cycleStart + CYCLE_MS;

				if (now < voteWindowEnd) {
					// voting
					const rem = voteWindowEnd - now;
					voteTimerEl.textContent = "Voting ends in: " + fmtTime(rem);
					phaseTextEl.textContent = "Phase: Voting";
					document.querySelectorAll(".vote-btn").forEach(b => b.disabled = false);
				} else if (now >= voteWindowEnd && now < revealEnd) {
					// reveal
					const rem = revealEnd - now;
					voteTimerEl.textContent = "Reveal ends in: " + fmtTime(rem);
					phaseTextEl.textContent = "Phase: Reveal";
					document.querySelectorAll(".vote-btn").forEach(b => b.disabled = true);
					// handle reveal once per cycleStart
					if (lastHandledCycle !== cycleStart) {
						lastHandledCycle = cycleStart;
						handleRevealCycle(cycleStart);
					}
				} else {
					// between cycles (rare)
					voteTimerEl.textContent = "Voting ends in: --:--:--";
					phaseTextEl.textContent = "Phase: Waiting";
					document.querySelectorAll(".vote-btn").forEach(b => b.disabled = false);
				}
			}
			tick();
			timersInterval = setInterval(tick, 1000);
		}

		/* ============================
		   Reveal processing (idempotent)
		   ============================ */
		async function handleRevealCycle(cycleStart) {
			// check reveals to avoid double processing
			const revealKey = `reveal_${cycleStart}`;
			const processedSnap = await db.ref("reveals/" + revealKey).once("value");
			if (processedSnap.exists()) return;
			// wait briefly for last votes to settle
			setTimeout(async () => {
				// compute winner
				const votesSnap = await db.ref("votes").once("value");
				const votes = votesSnap.val() || {};
				let winner = "No votes";
				let max = -1;
				for (const opt of VOTE_OPTIONS) {
					const k = safeKey(opt);
					const c = Number(votes[k] || 0);
					if (c > max) { max = c;
						winner = opt; }
				}
				// store vault entry
				const vaultEntry = { winner, counts: votes, timestamp: Date.now(), cycleStart };
				await db.ref("vault").push(vaultEntry);
				// mark reveal processed
				await db.ref("reveals/" + revealKey).set({ processedAt: Date.now() });
				// show overlay to this client
				showWinnerOverlay(vaultEntry);
				// reset votes for next cycle (transactionless set since voting is disabled in reveal)
				const resetObj = {};
				VOTE_OPTIONS.forEach(o => resetObj[safeKey(o)] = 0);
				await db.ref("votes").set(resetObj);
				// advance voteStart if it equals the processed cycleStart
				await db.ref("voteStart").transaction(curr => {
					if (curr === null) return Date.now();
					if (Number(curr) === Number(cycleStart)) return Number(curr) + CYCLE_MS;
					return; // leave as-is
				});
			}, 1200);
		}

		/* ============================
		   Winner overlay UI
		   ============================ */
		function showWinnerOverlay(entry) {
			winnerSummary.textContent = `Winner: ${entry.winner}\nCounts: ${Object.entries(entry.counts||{}).map(kv=> `
			$ { decodeURIComponent(kv[0]) }: $ { kv[1] }
			`).join(", ")}`;
			const revealEnd = entry.cycleStart + CYCLE_MS;

			function tick() {
				const rem = revealEnd - Date.now();
				if (rem <= 0) { winnerTimer.textContent = "Reveal ended";
					clearInterval(winInt); } else winnerTimer.textContent = "Reveal ends in: " + fmtTime(rem);
			}
			tick();
			const winInt = setInterval(tick, 1000);
			winnerOverlay.style.display = "flex";
		}
		closeWinnerBtn.addEventListener('click', () => winnerOverlay.style.display = 'none');

		/* ============================
		   Voting attempt (enforced with DB transactions on server data)
		   ============================ */
		async function attemptVote(option) {
			// check phase
			if (phaseTextEl.textContent.startsWith("Phase: Reveal")) { alert("Voting is closed during reveal."); return; }
			// ensure client IP loaded (fetch occurs at init; if null, we still use anon)
			if (clientIP === null) await fetchIPOnce();
			// compute current cycleStart from canonical voteStart in DB
			const vsnap = await db.ref("voteStart").once("value");
			const start = Number(vsnap.val() || Date.now());
			const cyclesPassed = Math.floor((Date.now() - start) / CYCLE_MS);
			const cycleStart = start + cyclesPassed * CYCLE_MS;
			// ip key
			const ipKey = clientIP ? clientIP : ANON_ID;
			const ipVotesRef = db.ref(`ipVotes/${ipKey}/${cycleStart}`);
			try {
				// increment ipVotes in transaction
				const res = await ipVotesRef.transaction(curr => (curr || 0) + 1);
				if (!res.committed) { alert("Could not register vote. Try again."); return; }
				const newCount = res.snapshot.val();
				if (newCount > MAX_VOTES_PER_IP) {
					// revert by decrementing back
					await ipVotesRef.transaction(curr => Math.max(0, (curr || 0) - 1));
					alert(`Vote limit reached: ${MAX_VOTES_PER_IP} votes per ${VOTE_WINDOW_MS/3600000} hours.`);
					return;
				}
				// increment vote count safely using transaction
				const optKey = safeKey(option);
				await db.ref(`votes/${optKey}`).transaction(curr => (curr || 0) + 1);
				// immediate UI feedback handled by DB listener
			} catch (e) {
				console.error("Vote error", e);
				alert("There was an error submitting your vote. Try again.");
			}
		}

		/* ============================
		   Chat send
		   ============================ */
		chatSendBtn.addEventListener('click', sendChat);
		chatInputEl.addEventListener('keydown', e => { if (e.key === 'Enter') sendChat(); });

		async function sendChat() {
			const text = chatInputEl.value.trim();
			if (!text) return;
			// rate-limit client-side
			const lastAt = Number(localStorage.getItem('htv_last_chat_at') || 0);
			if (Date.now() - lastAt < 4000) { alert("Slow down â€” chat rate-limited."); return; }
			localStorage.setItem('htv_last_chat_at', String(Date.now()));
			const payload = { text, ts: Date.now(), nick: getUserNick() };
			try {
				await db.ref("chat").push(payload);
				chatInputEl.value = '';
			} catch (e) {
				console.error("Chat push error", e);
				alert("Could not send chat. Try again.");
			}
		}

		/* ============================
		   Initial fetch helpers & start
		   ============================ */
		async function fetchIPOnce() {
			try {
				const r = await fetch(IP_CHECK_URL);
				const j = await r.json();
				clientIP = j.ip.replace(/\./g, '-');
			} catch (e) {
				clientIP = null;
			}
		}

		/* ============================
		   Matrix background
		   ============================ */
		const canvas = document.getElementById('matrix');
		const ctx = canvas.getContext('2d');
		let W = canvas.width = window.innerWidth;
		let H = canvas.height = window.innerHeight;
		const letters = '01HACKTHEVOTEEXE'.split('');
		const fSize = 14;
		let cols = Math.floor(W / fSize);
		let drops = new Array(cols).fill(1);
		window.addEventListener('resize', () => { W = canvas.width = window.innerWidth;
			H = canvas.height = window.innerHeight;
			cols = Math.floor(W / fSize);
			drops = new Array(cols).fill(1); });

		function drawMatrix() {
			ctx.fillStyle = 'rgba(0,0,0,0.06)';
			ctx.fillRect(0, 0, W, H);
			ctx.fillStyle = 'rgba(0,212,255,0.95)';
			ctx.font = fSize + 'px monospace';
			for (let i = 0; i < cols; i++) {
				const ch = letters[Math.floor(Math.random() * letters.length)];
				ctx.fillText(ch, i * fSize, drops[i] * fSize);
				if (drops[i] * fSize > H && Math.random() > 0.975) drops[i] = 0;
				drops[i]++;
			}
		}
		setInterval(drawMatrix, 33);

		/* ============================
		   Startup
		   ============================ */
		(async function init() {
			document.getElementById('maxLabel').textContent = MAX_VOTES_PER_IP;
			await fetchIPOnce();
			await ensureDbInit();
			// listeners already set above
			// minor UI sync
			console.log("HackTheVote client ready. Nick:", getUserNick());
		})();
	</script>
</body>

</html>