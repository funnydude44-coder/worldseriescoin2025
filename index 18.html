<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>HackTheVote.exe</title>

<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">

<style>
  /* Reset & base */
  *{box-sizing:border-box;margin:0;padding:0}
  html,body{height:100%}
  body{
    font-family:'Orbitron',sans-serif;
    background:#000;
    color:#f7f7f7;
    text-shadow:0 0 6px rgba(204,102,255,0.12),0 0 12px rgba(204,102,255,0.06);
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    overflow-x:hidden;
    line-height:1.45;
  }

  /* Matrix canvas */
  canvas#matrix{position:fixed;inset:0;z-index:-1;width:100%;height:100%}

  /* Header */
  header{text-align:center;padding:26px 12px;background:transparent;z-index:2;position:relative}
  header img{height:128px;display:block;margin:0 auto 10px;filter:drop-shadow(0 0 12px rgba(204,102,255,0.12))}
  header h1{font-size:28px;letter-spacing:2px;margin-bottom:6px}
  .tagline{font-size:12px;color:#ffd6ff;opacity:0.95}

  /* Layout */
  main{max-width:1200px;margin:18px auto;padding:12px;display:grid;grid-template-columns:1fr 380px;gap:18px}
  @media(max-width:980px){ main{grid-template-columns:1fr;padding:12px} header img{height:100px} }

  /* Panels */
  .panel{background:rgba(0,0,0,0.78);border-radius:12px;border:2px solid rgba(204,102,255,0.08);padding:18px;box-shadow:0 8px 30px rgba(0,0,0,0.5)}
  .panel h2{color:#fff;margin-bottom:8px}
  .panel p{font-size:13px;color:#eaeaea;margin-bottom:10px}

  /* Vote section */
  .vote-note{font-size:12px;color:#ffd6ff;margin-bottom:10px}
  .vote-buttons{display:flex;flex-wrap:wrap;gap:12px}
  .vote-btn{
    flex:1 1 calc(50% - 12px);
    min-width:140px;
    background:rgba(255,255,255,0.02);
    color:#fff;
    border:2px solid rgba(204,102,255,0.12);
    padding:12px;border-radius:10px;cursor:pointer;position:relative;font-size:13px;
    transition:transform .12s ease, background .12s ease, color .12s ease;
  }
  .vote-btn:hover{ transform:scale(1.03); background:rgba(204,102,255,0.12); color:#000; }
  .vote-btn:disabled{opacity:0.5;cursor:not-allowed}
  .vote-count{position:absolute;top:6px;right:10px;font-size:11px;color:#ffd6ff}

  .timer{margin-top:12px;font-size:14px;color:#fff;font-weight:700}
  .phase{font-size:12px;color:#ffd6ff;margin-top:6px}

  /* Reactor */
  .reactor-bar{width:100%;background:rgba(0,0,0,0.55);height:32px;margin-top:12px;border-radius:10px;border:2px solid rgba(204,102,255,0.06);overflow:hidden}
  .reactor-fill{height:100%;width:0;background:linear-gradient(90deg,#cc66ff,#ff99ff);border-radius:10px;transition:width .5s ease-in-out}

  /* Vault */
  .vault-list{max-height:240px;overflow:auto;margin-top:12px;padding:10px;background:rgba(0,0,0,0.55);border-radius:8px;border:1px solid rgba(204,102,255,0.06);font-size:13px;color:#f0f0f0}
  .vault-item{padding:8px;border-bottom:1px dashed rgba(255,255,255,0.02)}

  /* Right column: buy + terminal + roadmap */
  .buy-btn{display:inline-block;padding:12px 16px;border-radius:8px;border:2px solid rgba(204,102,255,0.14);background:transparent;color:#fff;text-decoration:none;margin-bottom:8px;font-size:13px}
  .buy-btn:hover{background:rgba(204,102,255,0.12);color:#000}

  .terminal{display:flex;flex-direction:column;gap:10px}
  .chat-messages{height:300px;overflow:auto;padding:10px;background:rgba(0,0,0,0.5);border-radius:8px;border:1px solid rgba(204,102,255,0.06);font-size:13px;color:#f1f1f1}
  .chat-line{padding:6px 0;border-bottom:1px dotted rgba(255,255,255,0.02)}
  .chat-controls{display:flex;gap:8px}
  .chat-input{flex:1;padding:10px;border-radius:8px;border:2px solid rgba(204,102,255,0.06);background:rgba(255,255,255,0.02);color:#fff;font-size:13px}
  .chat-send{padding:10px 12px;border-radius:8px;border:2px solid rgba(204,102,255,0.06);background:transparent;color:#fff;cursor:pointer}
  .chat-send:hover{background:rgba(204,102,255,0.12);color:#000}

  .music-toggle{position:fixed;bottom:14px;right:14px;padding:8px 12px;border-radius:8px;border:2px solid rgba(204,102,255,0.12);background:rgba(0,0,0,0.6);color:#fff;cursor:pointer;font-size:13px;z-index:5}

  footer{text-align:center;padding:12px;font-size:12px;color:#bbb;margin-top:14px}
  @media(max-width:980px){
    .vote-btn{flex:1 1 100%}
    .chat-messages{height:220px}
  }
</style>
</head>
<body>

<canvas id="matrix"></canvas>

<header>
  <img src="hackthevote-logo.png" alt="HackTheVote.exe logo">
  <h1>HackTheVote.exe</h1>
  <div class="tagline">Every vote counts. Every choice matters.</div>
</header>

<main>
  <!-- LEFT -->
  <div class="panel" aria-labelledby="vision-heading">
    <section class="vision" id="vision-heading">
      <h2>HackTheVote.exe â€” The Meme Coin Where the Community Controls the Power</h2>
      <p>Every <strong>6 hours</strong> the community decides how creator rewards are spent. Vote, watch the reactor fill, and check the Vault of Decisions for past winners. This site is live with Firebase backing (no further configuration needed on your end beyond correct database rules).</p>
    </section>

    <section class="vote-section" style="margin-top:14px">
      <h2>Vote Now</h2>
      <div class="vote-note">Max votes per IP: <strong id="maxVotesLabel">6</strong> Â· Options may change daily</div>

      <div class="vote-buttons" id="voteButtons"></div>

      <div class="timer" id="voteTimer">Voting ends in: --:--:--</div>
      <div class="phase" id="phaseText">Phase: loading...</div>

      <div class="reactor-bar"><div class="reactor-fill" id="reactorFill"></div></div>

      <div class="vault-list" id="vaultList" aria-live="polite">
        <div style="color:#ffd6ff;font-size:13px;padding-bottom:6px">Vault of Decisions (past winners)</div>
        <div id="vaultItems"><em style="color:#ddd">Loading vault...</em></div>
      </div>
    </section>
  </div>

  <!-- RIGHT -->
  <aside style="display:flex;flex-direction:column;gap:12px">
    <div class="panel" style="text-align:center">
      <a class="buy-btn" href="https://pump.fun/profile/cryptocentric?tab=coins" target="_blank" rel="noopener">Buy on Pump.Fun</a>
      <div style="font-size:12px;margin-top:6px;color:#ffd6ff">Pump.Fun profile</div>
    </div>

    <div class="panel terminal">
      <h3 style="margin:0;text-align:center">Terminal Chat</h3>
      <div class="chat-messages" id="chatMessages" aria-live="polite"></div>
      <div class="chat-controls">
        <input id="chatInput" class="chat-input" placeholder="Type a message..." maxlength="200" />
        <button id="chatSendBtn" class="chat-send">Send</button>
      </div>
      <div style="font-size:12px;color:#ffd6ff;text-align:center">Auto-generated hacker nicknames (persistent)</div>
    </div>

    <div class="panel">
      <h3 style="margin:0 0 8px 0">Roadmap & Vision</h3>
      <p>We aim to grow HackTheVote.exe to a <strong>multi-million market cap and beyond</strong>. This project is community-first: <strong>100% of creator fees</strong> will be reinvested into the coin to fund boosts, community programs, and growth. Launch was completely fair â€” the developer purchased only <strong>1%</strong> of total supply. The community controls the destiny.</p>
      <ul style="text-align:left;margin-top:8px">
        <li>Phase 1: Launch & community activation</li>
        <li>Phase 2: Organic, community-driven growth</li>
        <li>Phase 3: Community programs & viral campaigns</li>
        <li>Phase 4: Market cap acceleration â€” community-led</li>
      </ul>
    </div>
  </aside>
</main>

<footer>&copy; 2025 HackTheVote.exe</footer>

<!-- Music + toggle -->
<button id="musicToggle" class="music-toggle">ðŸ”‡ Music</button>
<audio id="bgMusic" loop preload="auto">
  <source src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_12ba2d5b89.mp3?filename=cyberpunk-ambient-116383.mp3" type="audio/mpeg">
</audio>

<!-- Firebase compat libs -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
/* ==========================
   FIREBASE CONFIG - provided by you
   ========================== */
const firebaseConfig = {
  apiKey: "AIzaSyA1WO4psTnAgLR8izmg458nmRqKLr2u6Ag",
  authDomain: "betatesting-9a5b1.firebaseapp.com",
  projectId: "betatesting-9a5b1",
  storageBucket: "betatesting-9a5b1.firebasestorage.app",
  messagingSenderId: "51166178501",
  appId: "1:51166178501:web:3fbc400622688ddb6bd4ac",
  databaseURL: "https://betatesting-9a5b1-default-rtdb.firebaseio.com/"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ==========================
   Visual / Behavior config
   ========================== */
const VOTE_OPTIONS = ["Buybacks & Burns","Giveaways","Boosts","Donate to Good Causes"];
const MAX_VOTES_PER_IP = 6;
const VOTE_WINDOW_MS = 6 * 60 * 60 * 1000; // 6 hours
const REVEAL_MS = 1 * 60 * 60 * 1000; // 1 hour reveal
const CYCLE_MS = VOTE_WINDOW_MS + REVEAL_MS;
const IP_API = "https://api.ipify.org?format=json";

/* ==========================
   Matrix background
   ========================== */
const canvas = document.getElementById('matrix');
const ctx = canvas.getContext('2d');
let W = canvas.width = window.innerWidth;
let H = canvas.height = window.innerHeight;
const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789@#$%&*';
const fontSize = 16;
let columns = Math.floor(W / fontSize);
let drops = new Array(columns).fill(1);
function resizeCanvas(){ W = canvas.width = window.innerWidth; H = canvas.height = window.innerHeight; columns = Math.floor(W / fontSize); drops = new Array(columns).fill(1); }
window.addEventListener('resize', resizeCanvas);
function drawMatrix(){
  ctx.fillStyle = 'rgba(0,0,0,0.06)';
  ctx.fillRect(0,0,W,H);
  ctx.fillStyle = '#00bfff';
  ctx.font = fontSize + 'px monospace';
  for(let i=0;i<columns;i++){
    const ch = letters.charAt(Math.floor(Math.random()*letters.length));
    ctx.fillText(ch, i * fontSize, drops[i] * fontSize);
    if(drops[i]*fontSize > H && Math.random() > 0.975) drops[i] = 0;
    drops[i]++;
  }
}
setInterval(drawMatrix, 50);

/* ==========================
   Client Globals
   ========================== */
let clientIP = null; // e.g. "1-2-3-4"
let anonId = null;   // fallback if IP not available
let userNick = null;
let votePhase = 'loading';

/* ==========================
   Nick generation (deterministic)
   ========================== */
const ADJ = ["Phantom","Neon","Ghost","Silent","Cold","Frost","Shadow","Quantum","Static","Zero","Null","Cipher","Rogue","Vex","Echo","Blade"];
const NOUN = ["Byte","Cipher","Kernel","Spike","Flux","Proxy","Packet","Node","Virus","Matrix","Grid","Pulse","Trace","Terminal","Vector","Ghost"];
function djb2(s){ let h=5381; for(let i=0;i<s.length;i++) h=((h<<5)+h)+s.charCodeAt(i); return Math.abs(h); }
function twoDig(n){ return String(n%100).padStart(2,'0'); }
function deriveNick(id){
  const h = djb2(id.toString());
  const adj = ADJ[h % ADJ.length];
  const noun = NOUN[Math.floor(h/100) % NOUN.length];
  return `${adj}${noun}${twoDig(h)}`;
}
function getOrCreateAnon(){
  let a = localStorage.getItem('htv_anon_v1');
  if(!a){ a = 'anon-'+Math.random().toString(36).slice(2,10); localStorage.setItem('htv_anon_v1', a); }
  return a;
}

/* ==========================
   Initialize: fetch IP, setup DB if necessary, then start listeners
   ========================== */
async function init(){
  anonId = getOrCreateAnon();
  await fetchClientIP();
  userNick = clientIP ? deriveNick(clientIP) : deriveNick(anonId);
  await ensureDbInit();
  setupListeners();
  renderVoteButtons();
  updatePhaseAndTimers();
  renderChat(); renderVault();
}
init();

/* ==========================
   Fetch public IP (transform for DB key)
   ========================== */
async function fetchClientIP(){
  try{
    const r = await fetch(IP_API);
    const j = await r.json();
    clientIP = j.ip.replace(/\./g,'-');
  }catch(e){
    console.warn('IP fetch failed, using anon id fallback', e);
    clientIP = null;
  }
}

/* ==========================
   Ensure DB nodes exist (votes, voteStart)
   ========================== */
async function ensureDbInit(){
  // ensure votes node keys exist
  const votesSnap = await db.ref('votes').once('value');
  if(!votesSnap.exists()){
    const initObj = {};
    VOTE_OPTIONS.forEach(o => initObj[encodeURIComponent(o)] = 0);
    await db.ref('votes').set(initObj);
  }
  // ensure voteStart is set
  await db.ref('voteStart').transaction(curr=>{
    if(curr === null) return Date.now();
    return; // keep existing
  });
}

/* ==========================
   Render vote buttons (UI)
   ========================== */
const voteButtonsEl = document.getElementById('voteButtons');
function renderVoteButtons(){
  voteButtonsEl.innerHTML = '';
  VOTE_OPTIONS.forEach(opt=>{
    const key = encodeURIComponent(opt);
    const btn = document.createElement('button');
    btn.className = 'vote-btn';
    btn.dataset.opt = opt;
    btn.id = 'btn-' + key;
    btn.innerText = opt;
    const span = document.createElement('span');
    span.className = 'vote-count';
    span.id = 'count-'+key;
    span.innerText = '0';
    btn.appendChild(span);
    btn.addEventListener('click', ()=> attemptVote(opt, btn));
    voteButtonsEl.appendChild(btn);
  });
}

/* ==========================
   Listen for votes updates and update UI
   ========================== */
db.ref('votes').on('value', snap=>{
  const data = snap.val() || {};
  let total = 0;
  VOTE_OPTIONS.forEach(opt=>{
    const k = encodeURIComponent(opt);
    const c = Number(data[k] || 0);
    const el = document.getElementById('count-'+k);
    if(el) el.innerText = c;
    total += c;
  });
  // reactor fill: scale by total*5 clamped to 100
  const pct = Math.min(100, total * 5);
  document.getElementById('reactorFill').style.width = pct + '%';
});

/* ==========================
   Listen for voteStart to manage timers/phases
   ========================== */
db.ref('voteStart').on('value', snap=>{
  const ts = snap.val();
  if(!ts) return;
  // store locally for phase calculations
  localStorage.setItem('htv_voteStart_cached', String(ts));
  updatePhaseAndTimers();
});

/* ==========================
   Phase & timers UI logic
   ========================== */
let timersInterval = null;
function updatePhaseAndTimers(){
  if(timersInterval) clearInterval(timersInterval);
  function tick(){
    const now = Date.now();
    const start = Number(localStorage.getItem('htv_voteStart_cached') || Date.now());
    const cyclesPassed = Math.floor((now - start) / CYCLE_MS);
    const cycleStart = start + cyclesPassed * CYCLE_MS;
    const voteEnd = cycleStart + VOTE_WINDOW_MS;
    const revealEnd = cycleStart + CYCLE_MS;

    if(now < voteEnd){
      votePhase = 'voting';
      const rem = voteEnd - now;
      document.getElementById('voteTimer').textContent = 'Voting ends in: ' + fmtTime(rem);
      document.getElementById('phaseText').textContent = 'Phase: Voting';
      document.querySelectorAll('.vote-btn').forEach(b=> b.disabled = false);
    } else if(now >= voteEnd && now < revealEnd){
      votePhase = 'reveal';
      const rem = revealEnd - now;
      document.getElementById('voteTimer').textContent = 'Reveal ends in: ' + fmtTime(rem);
      document.getElementById('phaseText').textContent = 'Phase: Reveal';
      document.querySelectorAll('.vote-btn').forEach(b=> b.disabled = true);
      // trigger reveal processing once
      handleRevealCycle(cycleStart);
    } else {
      // should rarely happen; treat as voting
      votePhase = 'voting';
      document.getElementById('voteTimer').textContent = 'Voting ends in: --:--:--';
      document.getElementById('phaseText').textContent = 'Phase: Waiting';
      document.querySelectorAll('.vote-btn').forEach(b=> b.disabled = false);
    }
  }
  tick();
  timersInterval = setInterval(tick, 1000);
}

/* ==========================
   Reveal processing (idempotent)
   ========================== */
async function handleRevealCycle(cycleStart){
  const revealKey = 'reveal_'+cycleStart;
  const exists = await db.ref('reveals/' + revealKey).once('value');
  if(exists.exists()) return; // already processed
  // small delay to allow last writes to settle
  setTimeout(async ()=>{
    // snapshot votes and pick winner
    const votesSnap = await db.ref('votes').once('value');
    const votes = votesSnap.val() || {};
    let winner = 'No votes';
    let max = -1;
    for(const opt of VOTE_OPTIONS){
      const k = encodeURIComponent(opt);
      const c = Number(votes[k] || 0);
      if(c > max){ max = c; winner = opt; }
    }
    // push vault entry
    const entry = { winner, counts: votes, timestamp: Date.now(), cycleStart };
    await db.ref('vault').push(entry);
    // mark processed
    await db.ref('reveals/' + revealKey).set({ processedAt: Date.now() });
    // show overlay client-side
    showWinnerOverlay(entry);
    // reset votes atomically (set to zeros)
    const resetObj = {};
    VOTE_OPTIONS.forEach(o => resetObj[encodeURIComponent(o)] = 0);
    await db.ref('votes').set(resetObj);
    // advance voteStart if it matches processed cycleStart
    await db.ref('voteStart').transaction(curr=>{
      if(curr === null) return Date.now();
      if(Number(curr) === Number(cycleStart)) return Number(curr) + CYCLE_MS;
      return; // someone else advanced
    });
  }, 1500);
}

/* ==========================
   Winner overlay UI
   ========================== */
function showWinnerOverlay(entry){
  const overlay = document.createElement('div');
  overlay.style.position='fixed'; overlay.style.inset=0; overlay.style.display='flex';
  overlay.style.alignItems='center'; overlay.style.justifyContent='center';
  overlay.style.background='rgba(0,0,0,0.96)'; overlay.style.zIndex=9999;
  const box = document.createElement('div');
  box.style.background='rgba(0,0,0,0.9)'; box.style.border='3px solid rgba(204,102,255,0.12)';
  box.style.padding='28px'; box.style.borderRadius='12px'; box.style.textAlign='center'; box.style.color='#fff';
  const counts = Object.entries(entry.counts || {}).map(kv=> `${decodeURIComponent(kv[0])}:${kv[1]}`).join(', ');
  box.innerHTML = `<h2 style="margin-bottom:10px">ðŸ’¡ The People Have Spoken â€” Decision Confirmed</h2>
                   <div style="font-size:15px;color:#ffd6ff;margin-bottom:8px">Winner: ${entry.winner}</div>
                   <div style="font-size:13px;color:#eaeaea">Counts: ${counts || 'none'}</div>
                   <div style="margin-top:14px"><button id="closeWinnerBtn" style="padding:10px 14px;border-radius:8px;border:2px solid rgba(204,102,255,0.12);background:transparent;color:#fff;cursor:pointer">Close</button></div>`;
  overlay.appendChild(box);
  document.body.appendChild(overlay);
  document.getElementById('closeWinnerBtn').addEventListener('click', ()=> overlay.remove());
  // auto-hide after reveal window or 60s (whichever is sooner for UX)
  setTimeout(()=>{ try{ overlay.remove(); }catch(e){} }, Math.min(REVEAL_MS, 60*1000));
}

/* ==========================
   Vote attempt logic with per-IP limit (transactions)
   ========================== */
async function attemptVote(option, btnEl){
  if(votePhase !== 'voting'){ alert('Voting is currently closed.'); return; }
  // ensure clientIP loaded
  if(clientIP === null) await fetchClientIP();
  // compute current cycleStart from canonical voteStart in DB
  const vsnap = await db.ref('voteStart').once('value');
  const start = Number(vsnap.val() || Date.now());
  const now = Date.now();
  const cyclesPassed = Math.floor((now - start) / CYCLE_MS);
  const cycleStart = start + cyclesPassed * CYCLE_MS;

  const ipKey = clientIP ? clientIP : ('anon-'+anonId);
  const ipVotesRef = db.ref(`ipVotes/${ipKey}/${cycleStart}`);
  try{
    // increment ipVotes under that IP/cycle atomically
    const result = await ipVotesRef.transaction(curr=>{
      if(curr === null) return 1;
      return Number(curr) + 1;
    });
    if(!result.committed){
      alert('Could not register vote. Try again.');
      return;
    }
    const newCount = result.snapshot.val();
    if(newCount > MAX_VOTES_PER_IP){
      // revert (decrement)
      await ipVotesRef.transaction(curr => Math.max(0, (curr || 0) - 1));
      alert(`Vote limit reached for your IP. Max ${MAX_VOTES_PER_IP} votes per ${VOTE_WINDOW_MS/(60*60*1000)} hours.`);
      return;
    }
    // increment option count
    const optKey = encodeURIComponent(option);
    await db.ref(`votes/${optKey}`).transaction(curr => (curr || 0) + 1);
    // small click sound
    try{ new Audio('https://freesound.org/data/previews/256/256113_3263906-lq.mp3').play(); }catch(e){}
  }catch(e){
    console.error('Vote error', e);
    alert('Error submitting vote. Try again.');
  }
}

/* ==========================
   Vault rendering (listen to vault)
   ========================== */
db.ref('vault').limitToLast(100).on('value', snap=>{
  const container = document.getElementById('vaultItems');
  container.innerHTML = '';
  const val = snap.val();
  if(!val){ container.innerHTML = '<em style="color:#ddd">No past decisions yet.</em>'; return; }
  const entries = Object.values(val).sort((a,b)=> b.timestamp - a.timestamp);
  entries.forEach(e=>{
    const d = new Date(e.timestamp);
    const div = document.createElement('div');
    div.className = 'vault-item';
    div.innerHTML = `<div style="color:#ffd6ff;font-size:13px">${d.toLocaleString()} â€” Winner: ${e.winner}</div>
      <div style="font-size:12px;color:#eaeaea">Counts: ${Object.entries(e.counts||{}).map(kv=> `${decodeURIComponent(kv[0])}:${kv[1]}`).join(', ')}</div>`;
    container.appendChild(div);
  });
});

/* ==========================
   Terminal Chat (real-time)
   ========================== */
const chatRef = db.ref('chat');
const chatMessagesEl = document.getElementById('chatMessages');
const chatInput = document.getElementById('chatInput');
const chatSendBtn = document.getElementById('chatSendBtn');

chatSendBtn.addEventListener('click', sendChat);
chatInput.addEventListener('keydown', (e)=>{ if(e.key === 'Enter') sendChat(); });

let lastChatAt = 0;
const CHAT_RATE_LIMIT_MS = 8000; // 8 sec

async function sendChat(){
  const text = (chatInput.value || '').trim();
  if(!text) return;
  const now = Date.now();
  if(now - lastChatAt < CHAT_RATE_LIMIT_MS){ alert('Slow down â€” chat is rate-limited.'); return; }
  lastChatAt = now;
  const payload = { text, ts: now, nick: userNick };
  try{
    await chatRef.push(payload);
    chatInput.value = '';
    try{ new Audio('https://freesound.org/data/previews/256/256113_3263906-lq.mp3').play(); }catch(e){}
  }catch(e){
    console.error('Chat send error', e);
    alert('Could not send chat. Try again.');
  }
}

/* Listen for new chat messages (append as they come) */
chatRef.limitToLast(200).on('child_added', snap=>{
  const m = snap.val();
  const el = document.createElement('div');
  el.className = 'chat-line';
  const t = new Date(m.ts).toLocaleTimeString();
  el.innerText = `[${t}] [${m.nick}] ${m.text}`;
  chatMessagesEl.appendChild(el);
  chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
});

/* ==========================
   Utilities & periodic UI updates
   ========================== */
function fmtTime(ms){
  if(ms < 0) ms = 0;
  const hrs = Math.floor(ms/3600000);
  const mins = Math.floor((ms%3600000)/60000);
  const secs = Math.floor((ms%60000)/1000);
  return `${String(hrs).padStart(2,'0')}:${String(mins).padStart(2,'0')}:${String(secs).padStart(2,'0')}`;
}

/* small periodic sync (counts & reactor will be updated by listeners, but keep UI fresh) */
setInterval(()=>{
  // keep phase/timers accurate (phase listener uses voteStart)
  updatePhaseAndTimers();
}, 1000);

/* ==========================
   Music toggle
   ========================== */
const musicBtn = document.getElementById('musicToggle');
const bg = document.getElementById('bgMusic');
let musicOn = false;
musicBtn.addEventListener('click', ()=>{
  if(!musicOn){ bg.play().catch(()=>{}); musicBtn.textContent='ðŸ”Š Music On'; musicOn=true; }
  else { bg.pause(); musicBtn.textContent='ðŸ”‡ Music'; musicOn=false; }
});

/* ==========================
   Quick helpers for debugging
   ========================== */
window.HTV = {
  getNick: ()=> userNick,
  resetDemoDB: async ()=> {
    // WARNING: resets votes, ipVotes, vault, chat, reveals, voteStart
    if(!confirm('Reset votes, ipVotes, vault, chat, and voteStart in Firebase? This is destructive.')) return;
    const resetObj = {}; VOTE_OPTIONS.forEach(o=> resetObj[encodeURIComponent(o)] = 0);
    await db.ref('votes').set(resetObj);
    await db.ref('ipVotes').set(null);
    await db.ref('vault').set(null);
    await db.ref('chat').set(null);
    await db.ref('reveals').set(null);
    await db.ref('voteStart').set(Date.now());
    alert('Firebase demo reset complete.');
  }
};
</script>

</body>
</html>