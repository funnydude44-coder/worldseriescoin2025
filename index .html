<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>HackTheVote.exe â€” Live</title>

<!-- Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">

<style>
  /* RESET & BASE */
  *{box-sizing:border-box;margin:0;padding:0}
  html,body{height:100%}
  body{
    font-family: 'Orbitron', 'Press Start 2P', sans-serif;
    background:#000;
    color:#f5f5f5;
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    overflow-x:hidden;
    line-height:1.45;
  }

  /* MATRIX BACKGROUND */
  canvas#matrix{position:fixed;inset:0;z-index:-1;width:100%;height:100%}

  /* HEADER */
  header{
    text-align:center;
    padding:28px 12px;
    position:relative;
    z-index:10;
  }
  header img{
    height:140px;
    display:block;
    margin:0 auto 10px;
    filter: drop-shadow(0 0 12px rgba(204,102,255,0.12));
  }
  header h1{
    font-size:28px;
    letter-spacing:2px;
    margin-bottom:6px;
    color:#fff;
    text-shadow:0 0 8px #fff, 0 0 20px rgba(255,100,180,0.14);
  }
  .tagline{font-size:13px;color:#ffd6ff;opacity:0.95;margin-bottom:6px}
  .buy-link{display:inline-block;margin-top:6px;padding:10px 14px;border-radius:8px;border:2px solid rgba(204,102,255,0.12);color:#fff;text-decoration:none;font-size:13px}
  .buy-link:hover{background:rgba(204,102,255,0.12);color:#000}

  /* LAYOUT */
  main{
    max-width:1200px;
    margin:18px auto;
    padding:12px;
    display:grid;
    grid-template-columns:1fr 380px;
    gap:18px;
    position:relative;
    z-index:10;
  }
  @media(max-width:980px){
    main{grid-template-columns:1fr;padding:12px}
    header img{height:110px}
  }

  /* PANELS */
  .panel{
    background:rgba(0,0,0,0.78);
    border-radius:12px;
    border:2px solid rgba(204,102,255,0.08);
    padding:18px;
    box-shadow:0 8px 30px rgba(0,0,0,0.5);
  }
  .panel h2{color:#fff;margin-bottom:8px}
  .panel p{font-size:13px;color:#eaeaea;margin-bottom:10px}

  /* VOTE SECTION */
  .vote-note{font-size:12px;color:#ffd6ff;margin-bottom:10px}
  .vote-buttons{display:flex;flex-wrap:wrap;gap:12px;justify-content:center}
  .vote-btn{
    flex:1 1 calc(50% - 12px);
    min-width:140px;
    background:rgba(255,255,255,0.02);
    color:#fff;
    border:2px solid rgba(204,102,255,0.12);
    padding:12px;border-radius:10px;cursor:pointer;position:relative;font-size:13px;
    transition:transform .12s ease, background .12s ease, color .12s ease;
    text-align:center;
  }
  .vote-btn:hover{ transform:scale(1.03); background:rgba(204,102,255,0.12); color:#000; }
  .vote-btn:disabled{opacity:0.5;cursor:not-allowed}
  .vote-count{position:absolute;top:6px;right:10px;font-size:11px;color:#ffd6ff}
  .timer{margin-top:12px;font-size:14px;color:#fff;font-weight:700;text-align:center}
  .phase{font-size:12px;color:#ffd6ff;margin-top:6px;text-align:center}

  /* REACTOR */
  .reactor-bar{width:100%;background:rgba(0,0,0,0.55);height:32px;margin-top:12px;border-radius:10px;border:2px solid rgba(204,102,255,0.06);overflow:hidden}
  .reactor-fill{height:100%;width:0;background:linear-gradient(90deg,#00bfff,#cc66ff);border-radius:10px;transition:width .5s ease-in-out}

  /* VAULT */
  .vault-list{max-height:240px;overflow:auto;margin-top:12px;padding:10px;background:rgba(0,0,0,0.55);border-radius:8px;border:1px solid rgba(204,102,255,0.06);font-size:13px;color:#f0f0f0}
  .vault-item{padding:8px;border-bottom:1px dashed rgba(255,255,255,0.02)}

  /* TERMINAL CHAT (Right column) */
  .chat-messages{height:300px;overflow:auto;padding:10px;background:rgba(0,0,0,0.6);border-radius:8px;border:1px solid rgba(204,102,255,0.06);font-size:13px;color:#f1f1f1}
  .chat-line{padding:6px 0;border-bottom:1px dotted rgba(255,255,255,0.02)}
  .chat-controls{display:flex;gap:8px;margin-top:8px}
  .chat-input{flex:1;padding:10px;border-radius:8px;border:2px solid rgba(204,102,255,0.06);background:rgba(255,255,255,0.02);color:#fff;font-size:13px}
  .chat-send{padding:10px 12px;border-radius:8px;border:2px solid rgba(204,102,255,0.06);background:transparent;color:#fff;cursor:pointer}
  .chat-send:hover{background:rgba(204,102,255,0.12);color:#000}

  /* MUSIC TOGGLE & FOOTER */
  .music-toggle{position:fixed;bottom:14px;right:14px;padding:8px 12px;border-radius:8px;border:2px solid rgba(204,102,255,0.12);background:rgba(0,0,0,0.6);color:#fff;cursor:pointer;font-size:13px;z-index:5}
  footer{text-align:center;padding:12px;font-size:12px;color:#bbb;margin-top:14px}

  @media(max-width:980px){
    .vote-btn{flex:1 1 100%}
    .chat-messages{height:220px}
  }

  /* WINNER OVERLAY */
  #winnerOverlay{position:fixed;inset:0;background:rgba(0,0,0,0.95);display:none;align-items:center;justify-content:center;z-index:9999;flex-direction:column}
  #winnerOverlay .box{border:3px solid rgba(204,102,255,0.12);padding:28px;border-radius:12px;background:rgba(0,0,0,0.88);text-align:center;color:#fff}
  #winnerOverlay h2{font-size:20px;margin-bottom:12px}
  #winnerOverlay .counts{color:#ffd6ff;margin-bottom:10px}
</style>
</head>
<body>

<!-- Matrix background canvas -->
<canvas id="matrix"></canvas>

<!-- Header -->
<header>
  <img src="hackthevote-logo.png" alt="HackTheVote.exe logo">
  <h1>HackTheVote.exe</h1>
  <div class="tagline">Every vote counts. Every choice matters.</div>
  <a class="buy-link" href="https://pump.fun/profile/cryptocentric?tab=coins" target="_blank" rel="noopener">Buy on Pump.Fun</a>
</header>

<!-- Main layout -->
<main>
  <!-- Left column: Vision + Vote + Vault -->
  <div class="panel" id="leftColumn">
    <section class="vision" aria-labelledby="vision-heading">
      <h2 id="vision-heading">HackTheVote.exe â€” The Meme Coin Where the Community Controls the Power</h2>
      <p>Every <strong>6 hours</strong> the community decides how creator rewards are spent. Vote, watch the reactor fill, and check the Vault of Decisions for past winners.</p>
    </section>

    <section class="panel vote-section" style="margin-top:12px;">
      <h2>Vote Now</h2>
      <div class="vote-note">Max votes per user: <strong id="maxVotesLabel">6</strong> Â· Options may change daily</div>

      <!-- VOTE BUTTONS (rendered immediately by JS) -->
      <div class="vote-buttons" id="voteButtons" aria-live="polite"></div>

      <div class="timer" id="voteTimer">Voting ends in: --:--:--</div>
      <div class="phase" id="phaseText">Phase: loading...</div>

      <div class="reactor-bar"><div class="reactor-fill" id="reactorFill"></div></div>

      <div class="vault-list" id="vaultList" aria-live="polite">
        <div style="color:#ffd6ff;font-size:13px;padding-bottom:6px">Vault of Decisions (past winners)</div>
        <div id="vaultItems"><em style="color:#ddd">No past decisions yet.</em></div>
      </div>
    </section>
  </div>

  <!-- Right column -->
  <aside class="panel" style="display:flex;flex-direction:column;gap:12px;">
    <div style="text-align:center">
      <a class="buy-link" href="https://pump.fun/profile/cryptocentric?tab=coins" target="_blank" rel="noopener">Buy on Pump.Fun</a>
    </div>

    <div>
      <h3 style="text-align:center;margin:0 0 8px 0;color:#fff">Terminal Chat</h3>
      <div class="chat-messages panel" id="chatMessages" aria-live="polite"></div>
      <div class="chat-controls" style="margin-top:8px">
        <input id="chatInput" class="chat-input" placeholder="Type a message..." maxlength="200" />
        <button id="chatSendBtn" class="chat-send">Send</button>
      </div>
      <div style="font-size:12px;color:#ffd6ff;margin-top:8px;text-align:center">Auto-generated hacker nicknames (persistent)</div>
    </div>

    <div class="panel">
      <h3 style="margin:0 0 8px 0">Roadmap & Vision</h3>
      <p>We aim to grow HackTheVote.exe to a <strong>multi-million market cap and beyond</strong>. This project is community-first: <strong>100% of creator fees</strong> will be reinvested into the coin to fund boosts, community programs, and growth. Launch was completely fair â€” the developer purchased only <strong>1%</strong> of total supply. The community controls the destiny.</p>
      <ul style="text-align:left;margin-top:8px">
        <li>Phase 1: Launch & community activation</li>
        <li>Phase 2: Organic, community-driven growth</li>
        <li>Phase 3: Community programs & viral campaigns</li>
        <li>Phase 4: Market cap acceleration â€” community-led</li>
      </ul>
    </div>
  </aside>
</main>

<footer>&copy; 2025 HackTheVote.exe â€” Live</footer>

<!-- Winner overlay -->
<div id="winnerOverlay">
  <div class="box">
    <h2 id="winnerTitle">The People Have Spoken â€” Decision Confirmed</h2>
    <div class="counts" id="winnerCounts"></div>
    <div id="winnerCountdown" class="timer"></div>
    <button id="closeWinnerBtn" style="margin-top:12px;padding:10px;border-radius:8px;border:2px solid rgba(204,102,255,0.12);background:transparent;color:#fff;cursor:pointer">Close</button>
  </div>
</div>

<!-- Music toggle button (floating) -->
<button id="musicToggle" class="music-toggle">ðŸ”‡ Music</button>

<!-- Firebase compat libs -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
/* ==========================
   CONFIG: your Firebase project
   ========================== */
const firebaseConfig = {
  apiKey: "AIzaSyA1WO4psTnAgLR8izmg458nmRqKLr2u6Ag",
  authDomain: "betatesting-9a5b1.firebaseapp.com",
  projectId: "betatesting-9a5b1",
  storageBucket: "betatesting-9a5b1.firebasestorage.app",
  messagingSenderId: "51166178501",
  appId: "1:51166178501:web:3fbc400622688ddb6bd4ac",
  databaseURL: "https://betatesting-9a5b1-default-rtdb.firebaseio.com/"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ==========================
   Constants & settings
   ========================== */
const VOTE_OPTIONS = ["Buybacks & Burns","Giveaways","Boosts","Donate to Good Causes"];
const MAX_VOTES = 6;
const VOTE_WINDOW_MS = 6 * 60 * 60 * 1000; // 6 hours
const REVEAL_MS = 1 * 60 * 60 * 1000; // 1 hour
const CYCLE_MS = VOTE_WINDOW_MS + REVEAL_MS;

/* ==========================
   Helpers
   ========================== */
function safeKey(s){ return encodeURIComponent(s); }
function fmtTime(ms){
  if(ms < 0) ms = 0;
  const hrs = Math.floor(ms/3600000);
  const mins = Math.floor((ms%3600000)/60000);
  const secs = Math.floor((ms%60000)/1000);
  return `${String(hrs).padStart(2,'0')}:${String(mins).padStart(2,'0')}:${String(secs).padStart(2,'0')}`;
}

/* ==========================
   MATRIX BACKGROUND
   ========================== */
const canvas = document.getElementById('matrix');
const ctx = canvas.getContext('2d');
let W = canvas.width = window.innerWidth;
let H = canvas.height = window.innerHeight;
const letters = '01HACKTHEVOTEEXE@#$%&*'.split('');
const fontSize = 14;
let columns = Math.floor(W / fontSize);
let drops = new Array(columns).fill(1);
function resizeMatrix(){ W = canvas.width = window.innerWidth; H = canvas.height = window.innerHeight; columns = Math.floor(W / fontSize); drops = new Array(columns).fill(1); }
window.addEventListener('resize', resizeMatrix);
function drawMatrix(){
  ctx.fillStyle = 'rgba(0,0,0,0.06)';
  ctx.fillRect(0,0,W,H);
  ctx.fillStyle = '#00bfff';
  ctx.font = fontSize + 'px monospace';
  for(let i=0;i<columns;i++){
    const ch = letters[Math.floor(Math.random()*letters.length)];
    ctx.fillText(ch, i*fontSize, drops[i]*fontSize);
    if(drops[i]*fontSize > H && Math.random()>0.975) drops[i]=0;
    drops[i]++;
  }
}
setInterval(drawMatrix, 33);

/* ==========================
   Immediate rendering of vote buttons (guaranteed visible)
   ========================== */
const voteButtonsEl = document.getElementById('voteButtons');
function renderVoteButtonsImmediate(){
  voteButtonsEl.innerHTML = '';
  VOTE_OPTIONS.forEach(opt=>{
    const key = safeKey(opt);
    const btn = document.createElement('button');
    btn.className = 'vote-btn';
    btn.dataset.opt = opt;
    btn.innerText = opt;
    const span = document.createElement('span');
    span.className = 'vote-count';
    span.id = 'count-' + key;
    span.innerText = '0';
    btn.appendChild(span);
    btn.addEventListener('click', ()=> attemptVote(opt, btn));
    voteButtonsEl.appendChild(btn);
  });
}
renderVoteButtonsImmediate();

/* ==========================
   IP + nick derivation
   ========================== */
let clientIP = null;
async function fetchIP(){
  try{
    const r = await fetch('https://api.ipify.org?format=json');
    const j = await r.json();
    clientIP = j.ip.replace(/\./g,'-');
  }catch(e){
    console.warn('IP fetch failed, using anon fallback', e);
    clientIP = null;
  }
}
fetchIP();

const ADJ = ["Phantom","Neon","Ghost","Silent","Cold","Frost","Shadow","Quantum","Static","Zero","Null","Cipher","Rogue","Vex","Echo","Blade"];
const NOUN = ["Byte","Cipher","Kernel","Spike","Flux","Proxy","Packet","Node","Virus","Matrix","Grid","Pulse","Trace","Terminal","Vector","Ghost"];
function djb2(s){ let h=5381; for(let i=0;i<s.length;i++) h=((h<<5)+h)+s.charCodeAt(i); return Math.abs(h); }
function deriveNick(id){ const h = djb2(id.toString()); const adj = ADJ[h % ADJ.length]; const noun = NOUN[Math.floor(h/100) % NOUN.length]; return `${adj}${noun}${String(h%100).padStart(2,'0')}`; }
function getAnonId(){ let a = localStorage.getItem('htv_anon_v2'); if(!a){ a = 'anon-'+Math.random().toString(36).slice(2,10); localStorage.setItem('htv_anon_v2', a);} return a; }
const anonId = getAnonId();
function getUserIdForNick(){ return clientIP ? clientIP : anonId; }
function getUserNick(){ return deriveNick(getUserIdForNick()); }

/* ==========================
   Ensure DB initial structure
   ========================== */
async function ensureDbSetup(){
  const votesSnap = await db.ref('votes').once('value');
  if(!votesSnap.exists()){
    const init = {};
    VOTE_OPTIONS.forEach(o => init[safeKey(o)] = 0);
    await db.ref('votes').set(init);
  }
  await db.ref('voteStart').transaction(curr => {
    if(curr === null) return Date.now();
    return;
  });
}
ensureDbSetup();

/* ==========================
   Listen for votes to update UI
   ========================== */
db.ref('votes').on('value', snap=>{
  const data = snap.val() || {};
  VOTE_OPTIONS.forEach(opt=>{
    const key = safeKey(opt);
    const el = document.getElementById('count-' + key);
    if(el) el.innerText = (data[key] || 0);
  });
  const total = Object.values(data).reduce((s,v)=> s + Number(v||0), 0);
  const pct = Math.min(100, total * 5);
  document.getElementById('reactorFill').style.width = pct + '%';
});

/* ==========================
   Listen for vault
   ========================== */
db.ref('vault').limitToLast(50).on('value', snap=>{
  const val = snap.val() || {};
  renderVaultFromData(val);
});

/* ==========================
   Listen for voteStart and manage phases/timers
   ========================== */
let currentVoteStart = null;
db.ref('voteStart').on('value', snap=>{
  if(!snap.exists()) return;
  currentVoteStart = Number(snap.val());
  startTimers();
});

/* Timer/Phase logic */
let timersInterval = null;
let votePhase = 'loading';
function startTimers(){
  if(timersInterval) clearInterval(timersInterval);
  function tick(){
    const start = Number(currentVoteStart || Date.now());
    const now = Date.now();
    const cyclesPassed = Math.floor((now - start) / CYCLE_MS);
    const cycleStart = start + cyclesPassed * CYCLE_MS;
    const voteEnd = cycleStart + VOTE_WINDOW_MS;
    const revealEnd = cycleStart + CYCLE_MS;
    if(now < voteEnd){
      votePhase = 'voting';
      document.getElementById('voteTimer').textContent = 'Voting ends in: ' + fmtTime(voteEnd - now);
      document.getElementById('phaseText').textContent = 'Phase: Voting';
      document.querySelectorAll('.vote-btn').forEach(b=> b.disabled = false);
    } else if(now >= voteEnd && now < revealEnd){
      votePhase = 'reveal';
      document.getElementById('voteTimer').textContent = 'Reveal ends in: ' + fmtTime(revealEnd - now);
      document.getElementById('phaseText').textContent = 'Phase: Reveal';
      document.querySelectorAll('.vote-btn').forEach(b=> b.disabled = true);
      handleRevealCycle(cycleStart);
    } else {
      votePhase = 'voting';
      document.getElementById('voteTimer').textContent = 'Voting ends in: --:--:--';
      document.getElementById('phaseText').textContent = 'Phase: Waiting';
      document.querySelectorAll('.vote-btn').forEach(b=> b.disabled = false);
    }
  }
  tick();
  timersInterval = setInterval(tick, 1000);
}

/* ==========================
   Attempt Vote (transactional)
   - ipVotes/{ip}/{cycleStart}
   - votes/{opt}
   ========================== */
async function attemptVote(option, buttonEl){
  if(votePhase !== 'voting'){ alert('Voting is currently closed.'); return; }
  if(clientIP === null) await fetchIP();
  const vsnap = await db.ref('voteStart').once('value');
  const start = Number(vsnap.val() || Date.now());
  const now = Date.now();
  const cyclesPassed = Math.floor((now - start) / CYCLE_MS);
  const cycleStart = start + cyclesPassed * CYCLE_MS;

  const ipKey = clientIP ? clientIP : ('anon-' + anonId);
  const ipVotesRef = db.ref(`ipVotes/${ipKey}/${cycleStart}`);

  try{
    const res = await ipVotesRef.transaction(curr => (curr || 0) + 1);
    if(!res.committed){ alert('Could not register vote. Try again.'); return; }
    const newCount = res.snapshot.val();
    if(newCount > MAX_VOTES){
      // revert increment
      await ipVotesRef.transaction(curr => Math.max(0, (curr || 1) - 1));
      alert(`Vote limit reached for your IP. Max ${MAX_VOTES} votes per 6 hours.`);
      return;
    }
    // increment votes for option
    const optKey = safeKey(option);
    await db.ref(`votes/${optKey}`).transaction(curr => (curr || 0) + 1);
    // feedback
    try{ new Audio('https://freesound.org/data/previews/256/256113_3263906-lq.mp3').play(); }catch(e){}
  }catch(err){
    console.error('Vote error', err);
    alert('Error submitting vote. Try again in a moment.');
  }
}

/* ==========================
   Reveal cycle handling
   - idempotent via reveals/reveal_{cycleStart}
   ========================== */
async function handleRevealCycle(cycleStart){
  const revealKey = `reveals/reveal_${cycleStart}`;
  const s = await db.ref(revealKey).once('value');
  if(s.exists()) return;
  // delay to let last votes settle
  setTimeout(async ()=>{
    const votesSnap = await db.ref('votes').once('value');
    const votes = votesSnap.val() || {};
    let winner = 'No votes'; let max = -1;
    VOTE_OPTIONS.forEach(opt=>{
      const c = Number(votes[safeKey(opt)] || 0);
      if(c > max){ max = c; winner = opt; }
    });
    const vaultEntry = { winner, counts: votes, timestamp: Date.now(), cycleStart };
    await db.ref('vault').push(vaultEntry);
    await db.ref(revealKey).set({ processedAt: Date.now() });
    showWinnerOverlay(vaultEntry);
    // reset votes for next cycle
    const resetObj = {};
    VOTE_OPTIONS.forEach(o => resetObj[safeKey(o)] = 0);
    await db.ref('votes').set(resetObj);
    // advance voteStart if needed
    await db.ref('voteStart').transaction(curr=>{
      if(curr === null) return Date.now();
      if(Number(curr) === Number(cycleStart)) return Number(curr) + CYCLE_MS;
      return;
    });
  }, 1200);
}

/* ==========================
   Winner overlay UI
   ========================== */
let overlayInterval = null;
function showWinnerOverlay(entry){
  const overlay = document.getElementById('winnerOverlay');
  document.getElementById('winnerTitle').innerText = 'ðŸ’¡ The People Have Spoken â€” Decision Confirmed';
  document.getElementById('winnerCounts').innerText = `Winner: ${entry.winner}`;
  const revealEnd = entry.cycleStart + CYCLE_MS;
  if(overlayInterval) clearInterval(overlayInterval);
  function tick(){
    const rem = revealEnd - Date.now();
    if(rem <= 0){ document.getElementById('winnerCountdown').innerText = 'Reveal ended'; clearInterval(overlayInterval); }
    else document.getElementById('winnerCountdown').innerText = 'Reveal ends in: ' + fmtTime(rem);
  }
  tick();
  overlayInterval = setInterval(tick,1000);
  overlay.style.display = 'flex';
}
document.getElementById('closeWinnerBtn').addEventListener('click', ()=> document.getElementById('winnerOverlay').style.display = 'none');

/* ==========================
   Vault render helper
   ========================== */
function renderVaultFromData(val){
  const list = document.getElementById('vaultItems');
  list.innerHTML = '';
  if(!val || Object.keys(val).length === 0){ list.innerHTML = '<em style="color:#ddd">No past decisions yet.</em>'; return; }
  const arr = Object.values(val).sort((a,b)=> b.timestamp - a.timestamp);
  arr.forEach(e=>{
    const d = new Date(e.timestamp);
    const el = document.createElement('div');
    el.className = 'vault-item';
    el.innerHTML = `<div style="color:#ffd6ff;font-size:13px">${d.toLocaleString()} â€” Winner: ${e.winner}</div>
      <div style="font-size:12px;color:#eaeaea">Counts: ${Object.entries(e.counts||{}).map(kv=> `${decodeURIComponent(kv[0])}:${kv[1]}`).join(', ')}</div>`;
    list.appendChild(el);
  });
}

/* ==========================
   Chat: push & listen
   ========================== */
const chatRef = db.ref('chat');
const chatMessagesEl = document.getElementById('chatMessages');
const chatInput = document.getElementById('chatInput');
const chatSendBtn = document.getElementById('chatSendBtn');
let lastChatAt = 0;
const CHAT_RATE_MS = 8000;

chatSendBtn.addEventListener('click', sendChat);
chatInput.addEventListener('keydown', (e)=>{ if(e.key === 'Enter') sendChat(); });

async function sendChat(){
  const text = chatInput.value.trim();
  if(!text) return;
  const now = Date.now();
  if(now - lastChatAt < CHAT_RATE_MS){ alert('Slow down â€” chat rate-limited.'); return; }
  lastChatAt = now;
  const nick = deriveNick(getUserIdForNick());
  try{
    await chatRef.push({ text, ts: now, nick });
    chatInput.value = '';
    try{ new Audio('https://freesound.org/data/previews/256/256113_3263906-lq.mp3').play(); }catch(e){}
  }catch(e){
    console.error('Chat send error', e);
    alert('Could not send chat. Try again.');
  }
}

chatRef.limitToLast(200).on('child_added', snap=>{
  const m = snap.val();
  const el = document.createElement('div');
  el.className = 'chat-line';
  const t = new Date(m.ts).toLocaleTimeString();
  el.textContent = `[${t}] [${m.nick}] ${m.text}`;
  chatMessagesEl.appendChild(el);
  chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
});

/* ==========================
   Startup: ensure DB, fetch IP, render buttons and start timers
   ========================== */
async function startup(){
  await fetchIP();
  await ensureDbSetup();
  // read voteStart
  const snap = await db.ref('voteStart').once('value');
  currentVoteStart = Number(snap.val());
  // ensure buttons exist (already rendered immediate)
  startTimers();
}
startup();

/* ==========================
   Periodic UI sync (in case)
   ========================== */
setInterval(()=>{
  // update vote counts placeholders if needed (db ref updates them anyway)
  // update reactor fill (db ref does it)
}, 1000);

/* ==========================
   Music toggle
   ========================== */
const musicBtn = document.getElementById('musicToggle');
const bgAudio = document.createElement('audio');
bgAudio.src = 'https://cdn.pixabay.com/download/audio/2022/03/15/audio_12ba2d5b89.mp3?filename=cyberpunk-ambient-116383.mp3';
bgAudio.loop = true; bgAudio.preload = 'auto'; bgAudio.volume = 0.28;
document.body.appendChild(bgAudio);
let musicOn = false;
musicBtn.addEventListener('click', ()=>{
  if(!musicOn){ bgAudio.play().catch(()=>{}); musicBtn.textContent='ðŸ”Š Music On'; musicOn=true; }
  else { bgAudio.pause(); musicBtn.textContent='ðŸ”‡ Music'; musicOn=false; }
});

/* ==========================
   Utility: expose helper & reset
   ========================== */
window.HTV = {
  getNick: ()=> getUserNick(),
  resetDemoDB: async ()=> {
    if(!confirm('This will remove votes, vault, ipVotes and chat from the database. Proceed?')) return;
    try{
      await db.ref('votes').remove();
      await db.ref('vault').remove();
      await db.ref('ipVotes').remove();
      await db.ref('chat').remove();
      await db.ref('reveals').remove();
      await db.ref('voteStart').remove();
      alert('Removed. Re-initializing DB nodes.');
      await ensureDbSetup();
    }catch(e){ console.error(e); alert('Reset failed - check console'); }
  }
};
</script>
</body>
</html>